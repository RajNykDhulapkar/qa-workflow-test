name: Merge to Integration QA

on:
  pull_request:
    types: [labeled]
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
      head_ref:
        required: true
        type: string

permissions:
  contents: write # Allows pushing to branches
  pull-requests: write # Allows commenting on PRs

env:
  QA_BRANCH: integration-qa-branch
  QA_LABEL: ready-for-int-qa

concurrency:
  group: integration-qa-merge # ensures only one merge job runs at a time
  cancel-in-progress: false # ensures that if a merge job is already running, it will not be cancelled

jobs:
  merge-to-qa:
    # For pull_request event, check label; for workflow_call, always run
    if: github.event_name == 'workflow_call' || github.event.label.name == 'ready-for-int-qa'
    runs-on: ubuntu-latest

    steps:
      - name: Set PR info
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" == "workflow_call" ]; then
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ inputs.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout QA branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.QA_BRANCH }}
          fetch-depth: 0
