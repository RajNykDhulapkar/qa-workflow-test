name: Reset QA Branch

on:
  workflow_dispatch: # Manual trigger

permissions:
  contents: write # Allows pushing to branches
  pull-requests: write # Allows commenting on PRs

env:
  QA_BRANCH: integration-qa-branch
  QA_LABEL: ready-for-int-qa

concurrency:
  group: integration-qa-merge # same group as merge workflow to prevent conflicts
  cancel-in-progress: true # cancel any in-progress merges when resetting

jobs:
  reset-qa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Reset QA branch to main
        run: |
          git branch -D ${{ env.QA_BRANCH }} || true
          git checkout -b ${{ env.QA_BRANCH }}
          git push origin ${{ env.QA_BRANCH }} --force

  get-prs-to-merge:
    needs: reset-qa
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-prs.outputs.matrix }}
      has_prs: ${{ steps.get-prs.outputs.has_prs }}
    steps:
      - name: Get PRs to re-merge
        id: get-prs
        uses: actions/github-script@v7
        with:
          script: |
            const qaLabel = '${{ env.QA_LABEL }}';
            const { data: { items: qaPrs } } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:pr is:open label:"${qaLabel}"`,
              per_page: 15
            });

            if (qaPrs.length === 0) {
              console.log(`No PRs with ${qaLabel} label found`);
              core.setOutput('matrix', JSON.stringify({ include: [] }));
              core.setOutput('has_prs', 'false');
              return;
            }

            console.log(`Found ${qaPrs.length} PRs to re-merge`);

            // Create matrix for workflow_call
            const matrix = {
              include: qaPrs.map(pr => ({
                pr_number: pr.number,
                head_ref: pr.head.ref,
                title: pr.title
              }))
            };

            console.log('Matrix:', JSON.stringify(matrix, null, 2));
            core.setOutput('matrix', JSON.stringify(matrix));
            core.setOutput('has_prs', 'true');

  merge-prs:
    needs: get-prs-to-merge
    if: needs.get-prs-to-merge.outputs.has_prs == 'true'
    strategy:
      max-parallel: 1 # Run sequentially to avoid conflicts
      fail-fast: false # Continue with other PRs if one fails
      matrix: ${{ fromJSON(needs.get-prs-to-merge.outputs.matrix) }}
    uses: ./.github/workflows/merge-to-qa.yml
    with:
      pr_number: ${{ matrix.pr_number }}
      head_ref: ${{ matrix.head_ref }}
